module day20
open System.Collections.Generic

let input = "###############################################################################################################
################################B#######C#########D#########E#####F###G#H######################################
##.#.#.#.#...#.....#...#.........#.....#.....#.....#.......#.....#.....#...#.#...#...#.#.............#.......##
##.#.#.#.###.#####.###.#########.#.###.#.#######.###.#.#####.#.###.###.#.#.#.#.#.#.###.#.#############.########
##...............#.#...#...........#...#...#.....#...#.#.....#.#.#.#...#.#.....#...#.#.......#...#.#...#...#.##
######.###.#####.#.###.###.###.#####.###.#####.#.#.#.###.#.###.#.###.#####.###.###.#.#.###.###.###.###.###.#.##
##.....#.#.#.#.....#.#.#.#...#.....#...#.....#.#.#.#...#.#.#...#.......#...#.#...#.#...#.......#.#.....#.#.#.##
########.###.#####.#.#.#.#.#.#########.#.#######.#.###.#.#####.#.#########.#.#.#####.###.#.#.#.#.#.#####.#.#.##
##.#...............#.#.....#.#.....#...#.....#.......#.#...#...#.....#...#.#...#...#...#.#.#.#.........#.....##
##.#.###.#.###.###.#.#.#.#######.#.#.#####.###########.#####.#.#.#.#####.###.#.#.###.#######.###########.######
##.#.#...#.#...#.#.....#.#.......#...#.....#...#.....#.#.....#.#.#.#.......#.#...........#.....#.#.#.#.#.....##
##.###########.#.#.#.###.#######.#######.#####.#.###.#.###.###.#.#########.###.#####.#.#.###.#.#.#.#.#.#.######
##.#.....#...#.#...#...#.#.#...#...#.......#.......#...#...#...#.....#.............#.#.#.#...#.#.....#.#...#.##
##.#.###.###.#.#.###.###.#.###.#.#######.#########.###########.#.#.###.###.###.#####.###############.#.#.###.##
##.....#.#.#...#.#...#.....#.#.....#.#.#.....#.#...#.......#...#.#...#.#...#...#.#.#.....#...#.#...#...#.....##
####.#####.###.#####.#######.#.#.###.#.###.###.#.#.###.#.#####.###.#######.###.#.#.#######.###.###.#.#####.####
##.........#...#.......#.......#.#.#...#.......#.#...#.#.....#.#.....#.....#.........#.#.#...#...#.......#...##
####.#####.###.#.#.###.#.###.#.#.#.#.#########.#.#######.###.#.#.#######.#####.###.###.#.#.###.###.#####.#.#.##
##...#.#.#.#.#.#.#.#...#.#.#.#.#.......#.#.....#.#.#...#.#.#.#.#.#.#.#.....#.#.#.#.#.........#...#.#.#.#...#.##
####.#.#.###.#######.#####.#.###.###.###.###.#.#.#.#.###.#.#.#.#.#.#.###.###.###.#####.#######.#####.#.###.####
##.....#...#...#.#.#.#.....#.#.....#.#.#.....#.#.....#.....#...#.....#...#.....#...#...#.....#.#...#.#.#.....##
####.###.###.#.#.#.#######.#####.#####.###.#.###.#.#.#####.#####.#######.###.###.###.#.###.###.###.#.#.###.#.##
##.......#.#.#.....#.#.#.#...#.#...#.#.....#.#.#.#.#.#.#.#.#...#...#.#...............#.#.#...#.#.#.#.......#.##
####.#####.###.###.#.#.#.#.###.#.###.###.#####.#.###.#.#.#.#.#.#.###.#.#.#####.#.#.#.###.#.###.#.#.#.#.#.######
##.#...#.....#.#.#.................#.#...#.........#.#.#.#...#.#.....#.#.#...#.#.#.#.........#.#...#.#.#...#.##
##.#.###.###.###.###.#.#.#.#####.###.###.#######.#####.#.#.###.#####.#.#.#.#.#.#.#.#.#.#####.#.#.#.#####.#.#.##
##.#.....#...#.....#.#.#.#.#...........#...#.......#.......#.....#...#.#.#.#...#.#.#.#.#...#.#.#.#.#.#...#...##
##.#.#######.#####.###.###.#########I#####J#####K###########G#####C#L#####B#############.#####.###.#.###.######
##.........#.#...#...#...#.#                                                       #...#.#.#...#.#.#.....#.#.##
####.#####.#####.#.#########                                                       #.###.#.###.#.#.###.#.#.#.##
##...#.#.#...#.#...#...#...#                                                       #.#...#.......#...#.#.....##
####.#.#.#####.###.###.#.###                                                       #.###.#####.#####.###.######
##...#.#.#.#...#...#.#...#.M                                                       #.#.#.#...#...#...#.#...#.##
##.#.#.#.#.###.###.#.###.#.#                                                       #.#.#.###.#.#####.#.#.###.##
##.#.......#.....#.....#...#                                                       #.#...#.#.........#.....#.##
##.###.#######.#.#.#.#.#.#.#                                                       #.#.#.#.#.#######.#.#.###.##
##.#...#.#...#.#.#.#.#.#.#.#                                                       N.#.#.#.#.......#...#...#.O#
##.#.###.#.###.###.#.###.###                                                       #.#.#.#.#.###.#########.#.##
#P.#...............#.......#                                                       #...#.#.....#.#.....#...#.Z#
######.#.#.#####.###.#.#####                                                       #.###.#.#########.###.###.##
#I.#.#.#.#...#.#...#.#.#...Q                                                       #.#.#...#.....#.#.#.......##
##.#.#########.#########.###                                                       ###.#####.#####.#.##########
##...#.#.#.#.....#.#.......#                                                       E...#...#.............#.#.##
##.#.#.#.#.###.#.#.###.#####                                                       ###.#.#####.###.#.#.###.#.##
##.#...........#.......#.#.#                                                       #.....#.....#...#.#...#...K#
##########.###.#########.#.#                                                       ###.###.###.#######.###.####
##.......#...#.#.#...#.....#                                                       #.#.....#.....#.....#.....##
##.#.###########.#.#.#.#.###                                                       #.###.#.###########.#####.##
##.#...#.#...#.#.#.#...#...#                                                       #.#.#.#.#.....#...........##
##.#.###.#.###.#.#.#####.###                                                       #.#.#####.###############.##
#R.#.......#.........#.....#                                                       #.............#.........#.##
######.###.###.#.#####.#####                                                       #.#.###.###.#######.#.#.####
##...#.#.......#...#.......O                                                       F.#.#.#.#.......#.#.#.#...##
##.#########.###.###.#.#.###                                                       #.###.#####.###.#.###.#.####
#N.......#.#...#.#...#.#.#.#                                                       #.#.....#...#.#.....#.#...##
##.#.#.#.#.#.#########.###.#                                                       #.###.#######.###.#.#.#.#.##
##.#.#.#.#.#.#.#...#...#.#.#                                                       #.#.....#.#...#.#.#...#.#.S#
######.#.#.###.#.#######.#.#                                                       #####.###.###.#.############
##.....#...#.#...#.#.......T                                                       U.........#...............V#
##########.#.###.#.###.#####                                                       #.#.###.###.#.#.###.###.#.##
##.#...#...................#                                                       #.#.#.....#.#.#...#.#...#.##
##.###.#####.#.#.#.#.#######                                                       #.#####.###.#########.######
##.........#.#.#.#.#.#.....#                                                       #.#.#.......#.#...#.#.#...##
####.#.#########.#####.###.#                                                       ###.#.#######.#.###.###.####
#U...#.#.......#.#.#.#.#...#                                                       #.....#.....#.............##
######.#.###.#####.#.#.#.###                                                       ###.#####.#.###.###.#.#.#.##
##.....#.#.....#.#...#.#...W                                                       #.#...#.#.#.....#.#.#.#.#.X#
##.#####.#.#####.#.#.#.#####                                                       #.#####.#.#.#.###.#.###.####
##.......#.........#.....#.#                                                       3.#.#.#...#.#.#.#.#.#.#...##
##################.###.#.#.#                                                       #.#.#.###.#.###.#.###.#.####
##...........#...#.#...#.#.#                                                       #.........#.#...#.#.....#.##
##.###.#.###.#.#.#.#.#####.#                                                       #.###.#########.#.#######.##
##.#.#.#...#...#.#.#.....#.0                                                       #.#...#.....#...#.....#...L#
##.#######.#.#############.#                                                       #######.#.#.#.#.#.#.#.#.####
#A.....#...#.......#.....#.#                                                       X...#...#.#...#...#.#.#...##
####.#######.###.#.###.###.#                                                       ###.#.#####.#####.###.#.#.##
#M.....#.#...#.#.#.........#                                                       #.#...#.........#.#.#.#.#.##
########.#####.###.#.###.###                                                       #.#.#######.###.###.#.###.##
#T.#.#...#.#.#.#.#.#.#.#.#.1                                                       #.....#.......#...#.......##
##.#.###.#.#.#.#.#####.###.#                                                       #.#######.#.###.#####.######
##.#.....#.....#...#.....#.#                                                       #.#.#.....#.#.....#.......##
##.#.#.###.###.#.#.#.###.#.#                                                       #.#.#.#.#.#.###.#####.#.####
##...#.....#.#...#...#.....#                                                       #.#.#.#.#.#.#.......#.#...##
######.#.#.#.#.#####.###.#.#                                                       ###.#####.#.###.#####.#.#.##
##.....#.#...#...#.....#.#.#                                                       #.#.#...#.#.#.#.#...#.#.#.##
####.#.###.#######.#.#####.#######R###H#########D#######P#######S#####2#######V#####.#.#.###.###.#.###.#.#.####
##...#.#.....#.....#.....#.......#...#.#.......#.#.#.....#...#.#.....#...#.....#...........#...#.......#.#...##
##.###.###.#.###.#.###.###.#.#####.###.#.###.###.#.###.###.#.#.###.###.#.#.#####.###.#.#.#######.#####.########
##.#.....#.#.#...#.#.....#.#.#.....#.....#...#...#.#.....#.#.#.......#.#.#.........#.#.#.#.#.......#.#.#.....##
######.#####.#####.###.#.#########.#######.#.#.###.#####.#.#.#.#########.###.###.#.#.#####.###.#####.#.###.####
##.........#.#.....#...#.#.#.........#.....#.#.......#.....#.#.......#...#...#...#.#.......#.#.#.............##
######.###.#######.#####.#.###.#####.#.#############.#######.#######.###.#.#####.#.###.###.#.#####.###.#####.##
##.......#.#...#.....#.......#.#.#.#.#.....#.#.......#.....#...#.#.....#.#.#...#.#.#.....#.....#...#.......#.##
##.###.#####.#.###.#.#.#.#######.#.#.###.###.#.#####.###.#.#.###.###.###.#.#.#########.#####.#.###.#.###.#.#.##
##.#.........#.#.#.#.#.#.#.....#.....#.......#.....#.#...#...#...#.#...#.#...........#.#.#.#.#...#.#.#.#.#.#.##
##.#.#.#.#.###.#.#############.###.#.#.#######.#####.#.###.###.###.#.###.#.#.#.#####.#.#.#.#.#########.#.######
##.#.#.#.#...#.#.#.....#...#.#...#.#.#...#.........#.#.#.......#.....#...#.#.#.#.....#...#.#.......#.#.....#.##
##.#.#.#.#.#####.###.#####.#.#.#.###.#.#.#.#######.#.#.###.#.#####.###.###.###############.#.#######.#####.#.##
##.#.#.#.#.....#.........#.#.#.#.#...#.#.#.#.....#.#.#.#...#.#.......#.#...#.#.......#...#.#...#...#.........##
####.#.#.###.###.#.#.###.#.#.###.#.###.#####.#.###.###.#############.#.###.#.#####.###.###.#.#####.#.#####.#.##
##...#.#.#.....#.#.#.#...............#.#...#.#.......#.........#.....#.#.#.......#.....#.#.........#.#.....#.##
########################.#.#########.#.###.#####.###.#.###########.#.#.#.###.#####.#####.###.#########.#.###.##
##.#.......#.............#.#.#.......#.......#.#.#.#.#...#...#.....#.#...#.....#.#.#...#.#.#...#.....#.#...#.##
##.#####.#.###.#############.#.###.#####.#####.###.#.#.###.#####.#######.#.#####.#.###.#.#.#######.#####.#.#.##
##.......#.......#.........#.#.#.....#.......#.......#.#.#.#.#.#.......#.#.....#...#.#...#.#.....#.#.#...#.#.##
##.###.###.#.#.###########.#.#######.#.#####.#######.#.#.#.#.#.#####.#.#.###.#.###.#.#.#.#.#.#.#.#.#.###.######
##...#.#...#.#.#.....#...#.....#...#.#.#.#...#...#...#.........#.....#.#.#...#...#.....#.....#.#.....#.#.....##
####.###.###.#####.#####.#.###.#.###.#.#.#######.###.#.#.###.#.#####.###.#.#######.#####.#######.#####.#####.##
##...#...#...#...........#.#.........#.......#.....#.#.#.#...#.#.#.....#.#...#.#.#.#.#...#.....#.#.......#.#.##
##.#.###.###.#####.#####.#####.#########.###.###.###.#####.#####.###.###.###.#.#.#.#.#####.#.###.#.#.#.#.#.####
##.#.#...#.......#...#.............#.......#.#.......#.........#.....#.....#...............#...#...#.#.#.....##
##################################W###2#########Q#######3#########0###1#######J################################
###############################################################################################################"

let testInput = "##################
########A#########
########.........#
########.#######.#
########.#######.#
########B#######.#
######       ###.#
#B..##       ###.#
###.##       ###.#
###..D       ###.#
######       ###.#
##########F#####.#
#D.#######...###.#
##.#########.###.#
#F.#########.....#
############Z#####
##################"

type Tile =
  | Empty
  | Wall
  | InnerPortal of char
  | OuterPortal of char
  | Start
  | Finish


let (|PortalChar|_|) (c: char) =
  if (c>='a' && c<='z') || (c>='B' && c<='Y') || (c>='0' && c<='9') then // exclude A and Z because that is start and finish
    Some c
  else
    None

let findPositions (board: Tile array array) tile =
  board
  |> Array.fold
    (fun (y,bs) l ->
      let (_, ls) =
        l
        |> Array.fold 
          (fun (x, xs) t ->
            if t = tile then
              (x+1, (x,y) :: xs)
            else
              (x+1, xs)
          )
          (0, [])
      (y+1, bs |> List.append ls)
    )
    (0,[])
  |> snd

let isPassable level tile =
  match tile with
  | Wall -> false
  | Empty | InnerPortal _ -> true
  | Start | Finish -> level = 0
  | OuterPortal _ -> level > 0

let searchPath board =
  let (startX, startY) = findPositions board Start |> List.head
  let openNodes = Priority_Queue.SimplePriorityQueue<int*int*int*int>() // level x y dist
  let visitedNodes = HashSet<int*int*int>() // level x y
  
  openNodes.Enqueue ((0, startX, startY, 0), 0.F)

  let mutable found = false
  let mutable resultDistance = System.Int32.MaxValue
  while not found do
    let (level, x,y,dist) = openNodes.Dequeue()
    visitedNodes.Add (level, x, y) |> ignore
    let tile = board.[y].[x]
    // printfn "%A %A" (level, x, y, dist) tile
    match tile with
    | Finish ->
      resultDistance <- dist
      found <- true
    | Empty | Start ->
      // add adjacent nodes
      [(x-1,y); (x+1,y); (x,y-1); (x,y+1)]
      |> List.iter (fun (nx, ny) ->
        if isPassable level board.[ny].[nx] && not (visitedNodes.Contains (level, nx, ny)) then
          openNodes.Enqueue((level, nx, ny, dist+1), float32 (dist+1))
      )
    | InnerPortal p ->
      // find other portal
      let portals = findPositions board (OuterPortal p)
      let (opx, opy) = portals |> List.head
      [(opx-1,opy); (opx+1,opy); (opx,opy-1); (opx,opy+1)]
      |> List.iter (fun (nx, ny) ->
        if isPassable (level+1) board.[ny].[nx] && not (visitedNodes.Contains (level+1, nx, ny)) then
          openNodes.Enqueue((level+1, nx, ny, dist+2), float32 (dist+2))
      )
    | OuterPortal p ->
      // find other portal
      let portals = findPositions board (InnerPortal p)
      let (opx, opy) = portals |> List.head
      [(opx-1,opy); (opx+1,opy); (opx,opy-1); (opx,opy+1)]
      |> List.iter (fun (nx, ny) ->
        if isPassable (level-1) board.[ny].[nx] && not (visitedNodes.Contains (level-1, nx, ny))  then
          openNodes.Enqueue((level-1, nx, ny, dist+2), float32 (dist+2))
      )
    | _ ->
      failwith (sprintf "Ended up on wall. should not happen: %d %d" x y)
  resultDistance

[<EntryPoint>]
let main argv =
  let board =
    input.Split("\r\n")
    |> Array.mapi (fun y l ->
      l
      |> Seq.mapi (fun x t ->
        match t with
        | PortalChar c -> if x=1 || y=1 || x=109 || y=111 then OuterPortal c else InnerPortal c
        | ' ' | '#' -> Wall
        | '.' -> Empty
        | 'A' -> Start
        | 'Z' -> Finish
        | x -> failwith (sprintf "Unknown board character %A" x)
      )
      |> Seq.toArray
    )

  printfn "%A" (searchPath board)
  0 // return an integer exit code
